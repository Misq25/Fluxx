<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fluxx - Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #app { width: 100%; max-width: 500px; background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .screen { display: none; }
        .active { display: flex; flex-direction: column; }
        #login-screen { text-align: center; gap: 15px; }
        .btn-primary { background: #00a884; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-google { background: white; color: black; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        #messages { border: 1px solid #333; height: 350px; overflow-y: auto; padding: 10px; margin-bottom: 15px; background: #121212; border-radius: 8px; display: flex; flex-direction: column; }
        .message-box { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; max-width: 80%; font-size: 0.9em; color: white; }
        .sent { background-color: #005c4b; align-self: flex-end; }
        .received { background-color: #202c33; align-self: flex-start; }
        .input-area { display: flex; gap: 10px; }
        input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; outline: none; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app">
    <div id="login-screen" class="screen active">
        <h2>Fluxx</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Mot de passe">
        <button class="btn-primary" onclick="loginWithEmail()">Se connecter</button>
        <p style="font-size: 0.8em; color: #888;">ou</p>
        <button class="btn-google" onclick="loginWithGoogle()">Se connecter avec Google</button>
    </div>

    <div id="chat-screen" class="screen">
        <div id="chat-header" style="margin-bottom: 10px; font-size: 0.8em; color: #888;"></div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="input" placeholder="Dire quelque chose...">
            <button onclick="sendMessage()" style="background: #00a884; border: none; color: white; padding: 0 15px; border-radius: 6px; cursor: pointer;">Envoyer</button>
        </div>
        <button onclick="logout()" style="background: none; border: none; color: #ff4444; font-size: 0.7em; margin-top: 10px; cursor: pointer;">Déconnexion</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    // REMPLACE l'URL ci-dessous par ton URL Render (ex: https://fluxx-api.onrender.com)
    const PROD_URL = "https://fluxx-api.onrender.com"; 
    const SUPABASE_URL = "https://kxztrkhxiosjfijvofeb.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4enRya2h4aW9zamZpanZvZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTY5MjUsImV4cCI6MjA4MTI3MjkyNX0.o_izj1w0L-1o9Y7tq1nEraHo1ZrO0ToNKQbqu4NpggI";

    // Correction ici : on utilise l'objet global fourni par le CDN
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentUser = null;
    let socket = null;

    // --- GESTION AUTH ---

    async function loginWithEmail() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
    }

    async function loginWithGoogle() {
        await _supabase.auth.signInWithOAuth({ 
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    }

    async function logout() {
        await _supabase.auth.signOut();
        location.reload();
    }

    _supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
            currentUser = session.user;
            showScreen('chat-screen');
            document.getElementById('chat-header').textContent = `Connecté : ${currentUser.email}`;
            syncProfile(session.user);
            initWebSocket();
        } else {
            showScreen('login-screen');
        }
    });

    async function syncProfile(user) {
        const profile = {
            id: user.id,
            username: user.email.split('@')[0],
            display_name: user.user_metadata.full_name || user.email.split('@')[0],
            avatar_url: user.user_metadata.avatar_url || ""
        };

        try {
            await fetch(`${PROD_URL}/api/sync-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profile)
            });
        } catch (e) { console.error("API hors ligne"); }
    }

    // --- GESTION WEBSOCKET ---

    function initWebSocket() {
        // On remplace http par ws et on utilise l'URL de prod
        const wsUrl = PROD_URL.replace("http", "ws") + "/ws";
        socket = new WebSocket(wsUrl);
        
        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const isMe = msg.sender === currentUser.id;
            displayMessage(isMe ? "Moi" : "Autre", msg.content, isMe ? 'sent' : 'received');
        };

        socket.onclose = () => setTimeout(initWebSocket, 3000); // Reconnexion auto
    }

    function sendMessage() {
        const input = document.getElementById('input');
        if (input.value.trim() && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ 
                content: input.value,
                sender: currentUser.id 
            }));
            input.value = '';
        }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function displayMessage(sender, text, className) {
        const div = document.createElement('div');
        div.classList.add('message-box', className);
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        const container = document.getElementById('messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>