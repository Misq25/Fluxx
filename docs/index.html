<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fluxx - Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #app { width: 100%; max-width: 500px; background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Écrans */
        .screen { display: none; }
        .active { display: flex; flex-direction: column; }

        /* Login */
        #login-screen { text-align: center; }
        .btn-google { background: white; color: black; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-google:hover { background: #ddd; }

        /* Chat */
        #messages { border: 1px solid #333; height: 350px; overflow-y: scroll; padding: 10px; margin-bottom: 15px; background: #121212; border-radius: 8px; }
        .message-box { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; max-width: 80%; font-size: 0.9em; }
        .sent { background-color: #005c4b; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background-color: #202c33; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; outline: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="login-screen" class="screen active">
        <h2>Bienvenue sur Fluxx</h2>
        <p>Connecte-toi pour commencer à chatter</p>
        <button class="btn-google" onclick="login()">Se connecter avec Google</button>
    </div>

    <div id="chat-screen" class="screen">
        <div id="chat-header" style="margin-bottom: 10px; font-size: 0.8em; color: #888;"></div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="input" placeholder="Dire quelque chose...">
            <button onclick="sendMessage()" style="background: #00a884; border: none; color: white; padding: 0 15px; border-radius: 6px; cursor: pointer;">Envoyer</button>
        </div>
        <button onclick="logout()" style="background: none; border: none; color: #ff4444; font-size: 0.7em; margin-top: 10px; cursor: pointer;">Déconnexion</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://fluxx_db.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4enRya2h4aW9zamZpanZvZmViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTY5MjUsImV4cCI6MjA4MTI3MjkyNX0.o_izj1w0L-1o9Y7tq1nEraHo1ZrO0ToNKQbqu4NpggI"; // C'est safe en public si tes RLS sont ON
    const GO_SERVER_URL = "http://localhost:8080";
    const GO_WS_URL = "ws://localhost:8080/ws";

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;
    let socket = null;

    // --- GESTION AUTH ---

    async function login() {
        await supabase.auth.signInWithOAuth({ 
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    }

    async function logout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // Détecter la session au chargement
    supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
            currentUser = session.user;
            showScreen('chat-screen');
            document.getElementById('chat-header').textContent = `Connecté en tant que ${currentUser.email}`;
            
            // 1. Synchroniser le profil avec le serveur Go
            syncProfile(session.user);
            
            // 2. Connecter le WebSocket
            initWebSocket();
        } else {
            showScreen('login-screen');
        }
    });

    async function syncProfile(user) {
        const profile = {
            id: user.id,
            username: user.email.split('@')[0],
            display_name: user.user_metadata.full_name,
            avatar_url: user.user_metadata.avatar_url
        };

        try {
            await fetch(`${GO_SERVER_URL}/api/sync-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profile)
            });
        } catch (e) {
            console.error("Serveur Go hors ligne ou erreur CORS");
        }
    }

    // --- GESTION WEBSOCKET ---

    function initWebSocket() {
        socket = new WebSocket(GO_WS_URL);
        
        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const isMe = msg.sender === currentUser.id;
            displayMessage(isMe ? "Moi" : "Autre", msg.content, isMe ? 'sent' : 'received');
        };
    }

    function sendMessage() {
        const input = document.getElementById('input');
        if (input.value.trim() && socket) {
            socket.send(JSON.stringify({ 
                content: input.value,
                sender: currentUser.id // On envoie notre ID Supabase
            }));
            input.value = '';
        }
    }

    // --- UI HELPERS ---

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function displayMessage(sender, text, className) {
        const div = document.createElement('div');
        div.classList.add('message-box', className);
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
</script>
</body>
</html>